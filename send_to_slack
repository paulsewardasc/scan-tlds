#!/usr/bin/python3
import sys
import os
import json
import requests


def send(block,priority,title):
    title = title + f' ({priority})'
    code = ''        
    for line in block:
      print(f'[+] {priority}: {line}')
      code = code + f'{line}\n'
    if len(code) > 0:
      array = []
      for i in range(0, len(code), 2048):
        array.append(code[i:i + 2048])
        for code in array:
          code = f'{title}\n```{code}```'
          print(code)
          send_code_to_slack(code)


def send_code_to_slack(code):
  code = {"text": code}
  code = json.dumps(code)
  token=os.environ['SLACK_API_TOKEN']
  url = f'https://hooks.slack.com/services/{token}'
  resp = requests.post(url, code)
  print(resp)

if __name__ == '__main__':
  # Get the filename from the first argument passed to the script.
  filename = sys.argv[1]
  try:
    title = sys.argv[2]
  except:
    title = 'SCAN Summary'

  # Read the contents of the text file.
  with open(filename, "r") as f:
    code = f.read()


  low=[]
  medium=[]
  high=[]
  critical=[]
  info=[]
  other=[]

  # Send the code to the Slack channel as code.
  print(f'[+] Sending: {code}')
  print(code)
  lines = code.split("\n")
  for line in lines:
    fields = line.split(" ")
    if len(fields) > 1:
      priority = fields[4]
      if priority == "[low]":
        low.append(line)
      elif priority == "[medium]":
        medium.append(line)
      elif priority == "[high]":
        high.append(line)
      elif priority == "[critical]":
        critical.append(line)
      elif priority == "[info]":
        info.append(line)
      else:
        other.append(line)

    send(info,"info",title)
    send(low,"low",title)
    send(medium,"medium",title)
    send(high,"high",title)
    send(critical,"critical",title)
 


